# TailorCloud 仕様書準拠状況分析

**作成日**: 2025-01  
**仕様書バージョン**: 1.0.0

---

## 📋 仕様書要件との比較

### ✅ 実装済み・準拠している項目

1. **データモデル構造** ✅
   - Users, Tenants, Orders, OrderDetails, Fabrics, Transactions の定義
   - ステータス遷移図の実装（Draft → Confirmed → ... → Paid）
   - マルチテナント対応（TenantIDによる分離）

2. **コンプライアンス要件の構造定義** ✅
   - ComplianceRequirement モデル
   - 下請法60日ルールの自動計算
   - バリデーションロジック

3. **アーキテクチャ設計** ✅
   - Clean Architecture準拠
   - マイクロサービス化への準備

---

## ⚠️ 仕様書との不一致・不足項目

### 🔴 Critical: データベース戦略の不一致

**仕様書の要件**:
> Primary DB (RDBMS): PostgreSQL (Cloud SQL)
> 用途: 注文データ、顧客台帳、会計データ、決済トランザクション（ACID特性が必要なもの）。
> 
> Secondary DB (NoSQL): Firestore
> 用途: 案件チャットログ、一時的なUIステータス、通知バッジ。

**現状の実装**:
- 注文データがFirestoreに保存されている
- PostgreSQLリポジトリが未実装

**必要な対応**:
- [ ] PostgreSQLリポジトリの実装
- [ ] 注文データをPostgreSQLに保存する設計への変更
- [ ] Firestoreは将来的なチャット機能用に予約

**優先度**: 🔴 最高（データ整合性の根幹）

---

### 🔴 Critical: 監査ログシステムの未実装

**仕様書の要件**:
> 監査ログ: 「誰が」「いつ」「どの数値を」変更したか、および「いつ契約書を閲覧したか」の完全なログ保存（法的証拠能力のため）。

**現状の実装**:
- `created_by`, `created_at`, `updated_at` のみ記録
- 監査ログテーブル未実装
- 変更履歴の追跡機能なし

**必要な対応**:
- [ ] 監査ログテーブル（AuditLog）の設計・実装
- [ ] 全データ変更操作のログ記録
- [ ] 契約書閲覧ログの記録
- [ ] 改ざん不可能なログ保存（改ざん防止）

**優先度**: 🔴 最高（法的証拠能力が必要）

---

### 🔴 Critical: 認証・権限管理の未実装

**仕様書の要件**:
> 認証・権限管理 (Auth & RBAC)
> - Firebase Auth (SMS認証/メールリンク認証)
> - Role: Owner, Staff, Factory_Manager, Worker
> - 各ロールの権限定義

**現状の実装**:
- ロール定義のみ（実装なし）
- Firebase認証統合なし
- 権限チェックなし

**必要な対応**:
- [ ] Firebase Auth ミドルウェアの実装
- [ ] JWTトークン検証
- [ ] RBAC（ロールベースアクセス制御）の実装
- [ ] 各エンドポイントでの権限チェック

**優先度**: 🔴 最高（セキュリティ必須）

---

### 🔴 High: PDF生成機能の未実装

**仕様書の要件**:
> コンプライアンスエンジン (Compliance Engine)
> - 発注確定トリガーと同時にバックグラウンドでPDF生成
> - PDF/A形式で生成し、Cloud Storageへ保存
> - ハッシュ値をDBに記録（改ざん防止）

**現状の実装**:
- PDF生成の構造定義のみ
- 実際のPDF生成ライブラリ未統合
- Cloud Storageへのアップロード未実装

**必要な対応**:
- [ ] PDF生成ライブラリの選定・統合
- [ ] 契約書テンプレートの作成
- [ ] Cloud Storageへのアップロード実装
- [ ] ハッシュ値計算・保存

**優先度**: 🔴 最高（Phase 1 MVPのコア機能）

---

### 🟡 Medium: 在庫連携APIの未実装

**仕様書の要件**:
> 在庫連携 (Inventory API)
> - 主要生地問屋の在庫システムと連携
> - Stock > 3.2m: ◎ (在庫あり)
> - 3.2m > Stock > 0: △ (要確認)
> - Stock = 0: × (Sold Out)

**現状の実装**:
- Fabricモデルの在庫ステータス計算ロジック実装済み ✅
- 外部API連携未実装
- CSVバッチ連携未実装

**必要な対応**:
- [ ] 外部API連携の実装（Phase 2）
- [ ] CSVバッチ連携の実装（Phase 1で可能）
- [ ] Safety Stockロジックの実装

**優先度**: 🟡 中（Phase 2で実装予定）

---

### 🟡 Medium: デジタル採寸カルテのバリデーション未実装

**仕様書の要件**:
> Validation: 異常値アラート（例: 前回の採寸より±5cm以上の差がある場合に警告）。

**現状の実装**:
- OrderDetailsにMeasurementData（JSON）を保存する構造のみ
- 異常値検出ロジック未実装

**必要な対応**:
- [ ] 前回採寸データとの比較ロジック
- [ ] ±5cm以上の差分検出
- [ ] アラート機能の実装

**優先度**: 🟡 中（Phase 1品質向上）

---

## 🔄 修正実装計画

### Phase 1.1: データベース戦略の修正（最優先）

**目標**: 仕様書通り、PostgreSQLをPrimary DBとして使用

1. **PostgreSQLリポジトリの実装**
   - [ ] PostgreSQL接続設定
   - [ ] OrderRepository（PostgreSQL版）の実装
   - [ ] CustomerRepositoryの実装
   - [ ] マイグレーションスクリプトの作成

2. **Firestoreの役割変更**
   - [ ] Firestoreはチャットログ・通知バッジ用に予約
   - [ ] 注文データはPostgreSQLに保存

**工数見積**: 3-5日

---

### Phase 1.2: 監査ログシステムの実装

**目標**: 法的証拠能力のある監査ログ

1. **監査ログテーブル設計**
   - [ ] AuditLog モデルの定義
   - [ ] PostgreSQLテーブル作成
   - [ ] ログ書き込み用リポジトリ

2. **監査ログ記録機能**
   - [ ] 全データ変更操作へのログ記録
   - [ ] 契約書閲覧ログ
   - [ ] 改ざん防止（ハッシュ値付与）

**工数見積**: 2-3日

---

### Phase 1.3: 認証・権限管理の実装

**目標**: Firebase認証とRBACの完全実装

1. **Firebase認証統合**
   - [ ] Firebase Auth ミドルウェア
   - [ ] JWTトークン検証
   - [ ] ユーザー情報の取得

2. **RBAC実装**
   - [ ] 権限チェックミドルウェア
   - [ ] 各エンドポイントでの権限チェック
   - [ ] ロール別アクセス制御

**工数見積**: 4-5日

---

### Phase 1.4: PDF生成機能の実装

**目標**: コンプライアンスエンジンの完成

1. **PDF生成ライブラリ統合**
   - [ ] ライブラリ選定（gofpdf / documentai）
   - [ ] PDF生成ロジック

2. **Cloud Storage連携**
   - [ ] PDFアップロード
   - [ ] ハッシュ値計算・保存
   - [ ] URLの生成

**工数見積**: 3-4日（テンプレート作成含む）

---

## 📊 実装優先順位マトリクス

| 項目 | 優先度 | 工数 | 依存関係 | 実装時期 |
|------|--------|------|----------|----------|
| PostgreSQLリポジトリ | 🔴 最高 | 3-5日 | なし | Phase 1.1 |
| 監査ログシステム | 🔴 最高 | 2-3日 | PostgreSQL | Phase 1.2 |
| Firebase認証・RBAC | 🔴 最高 | 4-5日 | なし | Phase 1.3 |
| PDF生成機能 | 🔴 最高 | 3-4日 | なし | Phase 1.4 |
| 在庫連携API | 🟡 中 | 5-7日 | なし | Phase 2 |
| 採寸異常値検出 | 🟡 中 | 2-3日 | なし | Phase 2 |

---

## 🎯 仕様書準拠達成目標

### Phase 1 MVP完了時点での準拠目標

- [x] データモデル構造の準拠
- [ ] PostgreSQLをPrimary DBとして使用
- [ ] 監査ログシステムの実装
- [ ] Firebase認証・RBACの実装
- [ ] PDF生成機能の実装

**達成率**: 20% → 目標: 100%

---

## 📝 次のアクション

1. **即座に着手**: PostgreSQLリポジトリの実装
2. **並行作業**: 監査ログシステムの設計
3. **Phase 1.1完了後**: 認証・権限管理の実装

---

**最終更新日**: 2025-01  
**次回レビュー予定日**: Phase 1.1完了時

